:9999 {
	header Content-Type text/html
	respond <<HTML
		<html>
			<head><title>Services not running...</title></head>
			<body>
				<style>p { text-align: center; margin-top: 40vh; font-size: 32px; }</style>
				<p>Something is down, please wait 30 seconds and then refresh...</p>
			</body>
		</html>
		HTML 503
}

# NextJS Frontend
localhost:3000 {
	handle /oauth2/* {
		 reverse_proxy localhost:4181 {
			  header_up X-Real-IP {remote_host}
			  header_up X-Forwarded-Uri {uri}
		 }
	}

	handle /account {
	   forward_auth localhost:4181 {
		   uri /oauth2/auth
		   header_up X-Real-IP {remote_host}
		   copy_headers X-Auth-Request-User X-Auth-Request-Email X-Auth-Request-Preferred-Username X-Auth-Request-Groups

		   @error status 401
		   handle_response @error {
			  redir * /oauth2/sign_in?rd={scheme}://{host}{uri}
		  }
	   }

		reverse_proxy localhost:4100 {
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-Uri {uri}
			lb_policy first
			lb_try_duration 1s
			fail_duration 5s
			transport http {
				dial_timeout 500ms
			}
		}
   }
}

# Keystone Manager
localhost:3100 {
	handle /oauth2/* {
		 reverse_proxy localhost:4180 {
			  header_up X-Real-IP {remote_host}
			  header_up X-Forwarded-Uri {uri}
		 }
	}

	handle {
	   forward_auth localhost:4180 {
		   uri /oauth2/auth
		   header_up X-Real-IP {remote_host}
		   copy_headers X-Auth-Request-User X-Auth-Request-Email X-Auth-Request-Preferred-Username X-Auth-Request-Groups

		   @error status 401
		   handle_response @error {
			  redir * /oauth2/sign_in?rd={scheme}://{host}{uri}
		  }
	   }

		reverse_proxy localhost:4100 {
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-Uri {uri}
			lb_policy first
			lb_try_duration 1s
			fail_duration 5s
			transport http {
				dial_timeout 500ms
			}
		}
   }
}

# Keycloak
localhost:3200 {
	handle {
	   reverse_proxy :8080 :9999 {
		 lb_policy first
		 lb_try_duration 1s
		 fail_duration 5s
		 transport http {
			dial_timeout 500ms
		}
	 }
   }
}